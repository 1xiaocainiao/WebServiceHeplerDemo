
## 无感刷新加解密, 刷新token也可以这样

### 刷新管理
···
final class KeyRefreshHelper {
    static let `default` = KeyRefreshHelper()
    
    private init() {}
    
    private var isRefreshing = false
    private var pendingCompletions: [(Bool) -> Void] = []
    
    private let semaphore = DispatchSemaphore(value: 1)
    
    func refreshKey(completion: @escaping (Bool) -> Void) {
        pendingCompletions.append(completion)
        
        let shouldStartRefresh = !isRefreshing
        if shouldStartRefresh { isRefreshing = true }
        
        guard shouldStartRefresh else { return }
        
        DispatchQueue.global().async {
            self.semaphore.wait()
            
            AppConfig.request { [weak self] config in
                guard let self = self else { return }
                
                self.isRefreshing = false
                
                let completions = self.pendingCompletions
                self.pendingCompletions.removeAll()
                
                completions.forEach { $0(config != nil) }
                
                self.semaphore.signal()
            }
        }
    }
}
···

### LXWebServiceHelper 中处理
```
    @discardableResult
    private func requestJSONObject<R: LXMoyaTargetType>(_ type: R,
                                                        progressBlock: ProgressBlock?,
                                                        completionHandle: @escaping JSONObjectHandle,
                                                        exceptionHandle: @escaping (Error?) -> Void) -> Moya.Cancellable? {
        let provider = createProvider(type: type)
        let cancelable = provider.request(type, callbackQueue: nil, progress: progressBlock) { result in
            switch result {
            case .success(let successResponse):
                do {
                    
                    let jsonObject = try successResponse.mapJSON()
                    
#if DEBUG
                    if let jsonData = try? JSONSerialization.data(withJSONObject: jsonObject, options: .prettyPrinted),
                       let jsonString = String(data: jsonData, encoding: .utf8) {
                        printl(message: "request path: \(type.path) \nresponse jsonString: \n \(jsonString)")
                    }
#else
#endif
                    
                    if let jsonObject = jsonObject as? [String: Any],
                       let statusCode = jsonObject[ServerKey.code.rawValue] as? Int, statusCode == ResponseErrorCode.DecryptError.rawValue {
                        self.handleDecryptFailure(type, progressBlock: progressBlock, completionHandle: completionHandle, exceptionHandle: exceptionHandle)
                        return
                    }
                    
                    completionHandle(jsonObject)
                } catch  {
                    exceptionHandle(LXError.serverDataFormatError)
                }
                break
            case .failure(let error):
                if error.errorCode == NSURLErrorTimedOut {
                    exceptionHandle(LXError.networkConnectTimeOut)
                } else {
                    exceptionHandle(LXError.networkConnectFailed)
                }
                break
            }
        }
        return cancelable
    }
    
    private func handleDecryptFailure<R: LXMoyaTargetType>(_ type: R,
                                                           progressBlock: ProgressBlock?,
                                                           completionHandle: @escaping JSONObjectHandle,
                                                           exceptionHandle: @escaping (Error?) -> Void) {
        KeyRefreshHelper.default.refreshKey { success in
            guard success else {
                exceptionHandle(LXError.serverDataFormatError)
                return
            }
            
            self.requestJSONObject(type,
                                   progressBlock: progressBlock,
                                   completionHandle: completionHandle,
                                   exceptionHandle: exceptionHandle)
        }
    }
```
